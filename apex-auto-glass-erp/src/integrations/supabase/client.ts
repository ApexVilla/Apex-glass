// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY;

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

// Valida√ß√£o das vari√°veis de ambiente
if (!SUPABASE_URL || !SUPABASE_PUBLISHABLE_KEY) {
  const missingVars = [];
  if (!SUPABASE_URL) missingVars.push('VITE_SUPABASE_URL');
  if (!SUPABASE_PUBLISHABLE_KEY) missingVars.push('VITE_SUPABASE_PUBLISHABLE_KEY');
  
  const errorMessage = `‚ùå ERRO: Vari√°veis de ambiente obrigat√≥rias n√£o configuradas: ${missingVars.join(', ')}\n` +
    `Configure essas vari√°veis no arquivo .env na raiz do projeto.\n` +
    `Exemplo:\n` +
    `VITE_SUPABASE_URL=https://seu-projeto.supabase.co\n` +
    `VITE_SUPABASE_PUBLISHABLE_KEY=sua-chave-publica`;
  
  // Em build time, lan√ßa erro para quebrar o build
  if (import.meta.env.MODE === 'production' || import.meta.env.PROD) {
    throw new Error(errorMessage);
  }
  
  // Em desenvolvimento, apenas avisa mas n√£o quebra
  console.error(errorMessage);
  console.warn('‚ö†Ô∏è O build falhar√° em produ√ß√£o se essas vari√°veis n√£o estiverem configuradas.');
}

// Aviso sobre problema de localStorage entre localhost e IP
if (typeof window !== 'undefined') {
  const hostname = window.location.hostname;
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    const hasSession = localStorage.getItem('apex-glass-auth') || 
                       Object.keys(localStorage).some(key => key.includes('supabase') && key.includes('auth'));
    
    if (!hasSession) {
      console.warn('üí° DICA: Se voc√™ fez login usando o IP (ex: 192.168.x.x:8081), precisa usar a mesma URL para manter a sess√£o.');
      console.warn('   O localStorage √© separado por origem (localhost ‚â† IP). Sempre use a mesma URL para acessar o sistema.');
    }
  }
}

// Garantir que as vari√°veis existem e n√£o s√£o placeholders
const isPlaceholder = (value: string | undefined) => {
  return !value || 
         value === 'placeholder-key' || 
         value === 'https://placeholder.supabase.co' ||
         value.startsWith('sua-') ||
         value.startsWith('seu-');
};

if (!SUPABASE_URL || !SUPABASE_PUBLISHABLE_KEY || 
    isPlaceholder(SUPABASE_URL) || isPlaceholder(SUPABASE_PUBLISHABLE_KEY)) {
  // Se chegou aqui em produ√ß√£o, j√° lan√ßou erro acima
  // Em desenvolvimento, ainda permite continuar com placeholders para n√£o quebrar o dev server
  if (import.meta.env.MODE === 'production' || import.meta.env.PROD) {
    throw new Error('Vari√°veis de ambiente do Supabase s√£o obrigat√≥rias e n√£o podem ser placeholders');
  }
}

// Log de diagn√≥stico (apenas em desenvolvimento)
if (import.meta.env.DEV) {
  console.log('üîç Diagn√≥stico Supabase:', {
    url: SUPABASE_URL ? `${SUPABASE_URL.substring(0, 30)}...` : '‚ùå N√£o configurado',
    key: SUPABASE_PUBLISHABLE_KEY ? `${SUPABASE_PUBLISHABLE_KEY.substring(0, 20)}...` : '‚ùå N√£o configurado',
    keyLength: SUPABASE_PUBLISHABLE_KEY?.length || 0,
  });
}

export const supabase = createClient<Database>(
  SUPABASE_URL || 'https://placeholder.supabase.co',
  SUPABASE_PUBLISHABLE_KEY || 'placeholder-key',
  {
    auth: {
      storage: typeof window !== 'undefined' ? window.localStorage : undefined,
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storageKey: 'apex-glass-auth', // Chave fixa para evitar problemas entre origens
      flowType: 'pkce', // Usar PKCE para melhor seguran√ßa e estabilidade
    },
    global: {
      headers: {
        'x-client-info': 'apex-glass-erp@1.0.0',
      },
    },
  }
);